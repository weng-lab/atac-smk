# Notes on each step of the MOHD-ATAC-seq pipeline

## 1. Inputs

1. Metadata file (.tsv) with the following columns:

- Sample (EA1000[1-50])
- R1 (Read 1 fastq file)
- R2 (Read 2 fastq file)

2. Reference genome (.fasta|.fa)

- GRCh38A

3. MultiQC config file (.yaml)

- Used to parse the sample ID from various report files generated by fastp, bowtie2, samtools, and picard
- https://github.com/ewels/MultiQC/blob/master/multiqc/templates/config.yaml

4. k (int)

- Bowtie2 parameter (defualt: 1)
- This parameter is used to specify the number of alignments to keep when mapping reads to the reference genome. By defualt, only the best reads are kept. However this can be modified to include k alignments or, by specifying -1, will keep ALL alignments.

5. qvals (list)

WIP

6. Directories

- `results_dir` (str)
- `workdir` (str)
- `tmpdir` (str)
- `logdir` (str)

## 2. Preprocessing (fastp)

From [openbioqueue](https://open.bioqueue.org/home/knowledge/showKnowledge/sig/fastp):

> It can filter out low-quality reads, which are sequences that have a high probability of containing errors. This is done based on quality scores that are assigned to each base in a read.
> It can trim adapter sequences, which are artificial sequences added during the preparation of sequencing libraries and are not part of the actual sample's genome.
> It can correct for errors in the sequencing process, such as mismatches or small insertions and deletions.
> It provides comprehensive quality control reports, including information on sequence quality, GC content, sequence length distribution, and more.

This rule efectively achieves is the equivalent to running fastqc -> cutadapt -> fastqc on the input fastq files. It gathers QC metrics and performs trimming and filtering of low-quality reads.

## 3. Alignment (bowtie2)

From [openbioqueue](https://open.bioqueue.org/home/knowledge/showKnowledge/sig/bowtie2):

> Aligning sequencing reads to long reference sequences. It is particularly good at aligning reads of about 50 up to 100s or 1,000s of characters to relatively long (e.g. mammalian) genomes. Bowtie 2 supports gapped, local, and paired-end alignment modes.

First an index is build using the reference genome sequeuce.

```bash
bowtie2-build <genome>.fa index/<genome>.fa
```

Then the paired-end reads are aligned to the indexed reference genome.

```bash
bowtie2 -X 2000 --mm (optionally -k <int>) \
            -x index/<genome>.fa \
            --rg-id <sample>-<genome> \
            --rg SM:<sample>-<genome> \
            -1 <R1> \
            -2 <R2>
```

Breaking some of the flags down, this is read as follows:

- `-X 2000`: Set the maximum fragment length to 2000 bp
- `--mm`: Use memory-mapped I/O to load the index (better performance)
- `-k <int>`: Specifes the number of alignments to keep (default: 1)
- `-x index/<genome>.fa`: Specifes the indexed reference genome
- `--rg-id...` an `--rg SM:...`: Add read group information to the output SAM file. This is useful metadata for downsteam analysis.
- `-1` and `-2`: Specify the paired-end reads

## 4. Post-alignment filtering

Depending on the value of `k`, the alignment step will either keep all alignments or only the best alignment. The following steps assume `k=1` was provided to bowtie2 during alignment.

```bash
samtools view -F 1804 -f 2 -q 30 -u  | \
samtools sort -n /dev/stdin -o tmp.nmsrt.bam
```

Using the BROAD institute's [website](https://broadinstitute.github.io/picard/explain-flags.html), we can interpret the meaning of the flags:

- `samtools view` is use to filter out the alignments according to bitwise OR flags.
    - `-F` denotes filtering conditions to EXCLUDE from the output while `-f` denotes conditions to INCLUDE in the output.
    - The number 1804 is the bitwise OR of the following flags:
        - read unmapped (0x4)
        - mate unmapped (0x8)
        - not primary alignment (0x100)
        - read fails platform/vendor quality checks (0x200)
        - read is PCR or optical duplicate (0x400)
    - The number 2 is the bitwise OR of the following flag:
        - is properly paired (0x2)
    - The `-q 30` flag filters out reads with mapping quality below 30
- `samtools sort`, as its name implies, sorts the filtered alignments by __name__ (QNAME).

```bash
samtools view -h tmp.nmsrt.bam | \
samtools fixmate -r /dev/stdin tmp.fixmate.bam
```

- `samtools fixmate` fills in information such as insert size, cigar, mapq about paired reads onto the corresponding mate. With the `-r` flag, this step also removes secondary and unmapped alignments.   

```bash
samtools view -F 1804 -f 2 -u tmp.fixmate.bam | \
samtools sort /dev/stdin -o tmp.coordsort.bam
```
- After fixmate, the the SAM flags have been updates, and the first filter must be applied to remove reads that fail the original conditions we specified.
- `samtools sort` __without__ `-n` will sort by __coordinate__ instead.

```bash
samtools view -h tmp.coordsort.bam | grep -v "chrM" | samtools view -b > output.bam
```
- Here the output of `samtools view` to filter out chrM alignments (via `grep`) then piped to `samtools view` to convert to a BAM format (binary format of SAM).

```bash
samtools index output.bam output.bam.bai
samtools flagstat --output-fmt "json" output.bam > output.flagstat.json
```
- `samtools index`, as its name implies, creates an index file for the BAM file.
- `samtools flagstat` produces alignment metrics format for qc and downsteam analysis.

**SKIPPING TO QC RULES. COME BACK TO THIS WHEN YOU HAVE TIME. THIS WILL BE A SPEC DOCUMENT**

## N. QC

### 1. Fragment length distribution

For each BAM file belonging to a sample, the fragment distribution is calulcated. This yields a histogram of fragment legnths with bins corresponding to mono-, di-, and tri-nucleosomal fragments as well as nucelosomal free. The "bins" are intervals of 147 bp until the max length threshold of 1000. We expect that the peaks of this histogram align with the 147 interval based on nucleosomal association.

### 2. TSS enrichment

The reference genode GTRF annotation file (v29) is used to generate a TSS reference bed file. See the source for this file [here](https://www.encodeproject.org/files/ENCFF493CCB/) on the ENCODE portal. Mathematically, this represents the following:

> Enrichment Score = max(Average Normalized Signal)
> Where:
>   Normalized Signal = Raw Signal / Mean(Flanking Background)
>   Average = Mean across all TSS sites
>   Max = Peak value in the averaged profile

### 3. FRiP (fraction of reads in peaks)

Essentially this is a bedtools intersection between the fragments (tagalign files) and the peaks (narrowPeak files)

### 4. Pseudoreplicates


